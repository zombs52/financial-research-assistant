<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Research Assistant - Multi-Agent Stock Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .search-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1.1rem;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-btn {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
        }

        .search-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .mode-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: #667eea;
            color: white;
        }

        .agents-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .agent-card:hover {
            transform: translateY(-5px);
        }

        .agent-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }

        .agent-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
        }

        .status-idle { background: #f0f0f0; color: #666; }
        .status-working { background: #fff3cd; color: #856404; }
        .status-complete { background: #d4edda; color: #155724; }
        .status-error { background: #f8d7da; color: #721c24; }

        .results-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: none;
        }

        .results-section.show {
            display: block;
        }

        .results-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .results-content {
            padding: 30px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .analysis-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
        }

        /* News Articles Styling */
        .news-articles {
            margin-top: 15px;
        }

        .news-article {
            border-left: 3px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .news-article:hover {
            transform: translateX(2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .news-article[data-impact="high"] {
            border-left-color: #dc3545;
        }

        .news-article[data-impact="medium"] {
            border-left-color: #ffc107;
        }

        .news-article[data-impact="low"] {
            border-left-color: #28a745;
        }

        .news-header {
            margin-bottom: 10px;
        }

        .news-title {
            margin: 0 0 8px 0;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .news-title a {
            color: #333;
            text-decoration: none;
            transition: color 0.2s;
        }

        .news-title a:hover {
            color: #667eea;
            text-decoration: underline;
        }

        .news-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .news-source {
            font-weight: 600;
            color: #495057;
        }

        .news-time {
            color: #6c757d;
        }

        .news-sentiment {
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }

        .sentiment-positive {
            background: #d4edda;
            color: #155724;
        }

        .sentiment-negative {
            background: #f8d7da;
            color: #721c24;
        }

        .sentiment-neutral {
            background: #e2e3e5;
            color: #383d41;
        }

        .news-summary {
            margin: 10px 0;
            line-height: 1.5;
            color: #495057;
        }

        .news-impact {
            margin-top: 10px;
        }

        .impact-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .impact-high {
            background: #ff6b6b;
            color: white;
        }

        .impact-medium {
            background: #feca57;
            color: #333;
        }

        .impact-low {
            background: #48dbfb;
            color: #333;
        }

        .news-disclaimer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
            text-align: center;
            color: #6c757d;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
        }

        .recommendation {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        .recommendation.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
        }

        .recommendation.danger {
            background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
        }

        .chart-container {
            margin: 20px 0;
            height: 400px;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .tooltip {
            position: relative;
            cursor: help;
            border-bottom: 1px dotted #666;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.9rem;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .comparison-winner {
            border: 3px solid #28a745 !important;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(40, 167, 69, 0.05) 100%);
        }

        .comparison-loser {
            border: 2px solid #dc3545 !important;
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.05) 0%, rgba(220, 53, 69, 0.02) 100%);
        }

        .comparison-tie {
            border: 2px solid #ffc107 !important;
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 193, 7, 0.05) 100%);
        }

        .comparison-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .comparison-summary .metric-label,
        .comparison-summary .metric-value {
            color: white;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            .search-input {
                min-width: 100%;
            }
            
            .analysis-grid {
                grid-template-columns: 1fr;
            }
        }

        /* News Section Styles */
        .news-articles {
            margin-top: 15px;
        }

        .news-article {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
        }

        .news-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .news-sentiment, .news-impact {
            font-size: 1.2em;
        }

        .news-source {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
        }

        .news-title {
            margin: 10px 0;
            color: #333;
            font-size: 1.1em;
        }

        .news-summary {
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
        }

        .news-date {
            color: #888;
        }

        .news-sentiment-label {
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: bold;
            text-transform: capitalize;
        }

        .sentiment-positive {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .sentiment-negative {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .sentiment-neutral {
            background: rgba(108, 117, 125, 0.2);
            color: #6c757d;
        }

        /* Fundamentals Section Styles */
        .valuation-overvalued {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }

        .valuation-undervalued {
            border-left: 4px solid #28a745;
            background: rgba(40, 167, 69, 0.05);
        }

        .valuation-fair {
            border-left: 4px solid #ffc107;
            background: rgba(255, 193, 7, 0.05);
        }

        .valuation-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.9em;
        }

        .valuation-overvalued .valuation-badge {
            background: #dc3545;
            color: white;
        }

        .valuation-undervalued .valuation-badge {
            background: #28a745;
            color: white;
        }

        .valuation-fair .valuation-badge {
            background: #ffc107;
            color: #212529;
        }

        .valuation-reasoning {
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
        }

        .valuation-reasoning ul {
            margin: 10px 0 0 20px;
        }

        .valuation-reasoning li {
            margin-bottom: 5px;
        }

        .business-section {
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid #eee;
        }

        .business-section:first-child {
            border-top: none;
        }

        .business-section ul {
            margin: 8px 0 0 20px;
        }

        .business-section li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Financial Research Assistant</h1>
            <p>Multi-Agent Stock Analysis System</p>
        </div>

        <div class="search-section">
            <form class="search-form" id="searchForm">
                <input 
                    type="text" 
                    class="search-input" 
                    id="stockSymbol" 
                    placeholder="Enter stock symbol (e.g., AAPL, TSLA, ASML)" 
                    required
                >
                <button type="submit" class="search-btn" id="analyzeBtn">
                    🔍 Analyze Stock
                </button>
            </form>
            
            <div class="mode-toggle">
                <button class="mode-btn active" data-mode="beginner">👶 Beginner Mode</button>
                <button class="mode-btn" data-mode="advanced">🎓 Advanced Mode</button>
            </div>
            
            <div class="portfolio-controls" style="margin-top: 15px;">
                <button class="mode-btn" id="addToPortfolioBtn" disabled>📁 Add to Portfolio</button>
                <button class="mode-btn" id="viewPortfolioBtn">💼 View Portfolio (<span id="portfolioCount">0</span>)</button>
                <button class="mode-btn" id="compareBtn" disabled>⚖️ Compare Stocks</button>
            </div>
        </div>

        <div class="agents-status" id="agentsStatus">
            <div class="agent-card">
                <div class="agent-icon">📊</div>
                <h3>Data Agent</h3>
                <p>Fetches stock information</p>
                <span class="agent-status status-idle" id="dataAgentStatus">Idle</span>
            </div>
            
            <div class="agent-card">
                <div class="agent-icon">🔬</div>
                <h3>Analysis Agent</h3>
                <p>Calculates technical indicators</p>
                <span class="agent-status status-idle" id="analysisAgentStatus">Idle</span>
            </div>
            
            <div class="agent-card">
                <div class="agent-icon">💭</div>
                <h3>Sentiment Agent</h3>
                <p>Analyzes market sentiment</p>
                <span class="agent-status status-idle" id="sentimentAgentStatus">Idle</span>
            </div>
            
            <div class="agent-card">
                <div class="agent-icon">📋</div>
                <h3>Report Agent</h3>
                <p>Generates final report</p>
                <span class="agent-status status-idle" id="reportAgentStatus">Idle</span>
            </div>
            
            <div class="agent-card">
                <div class="agent-icon">📰</div>
                <h3>News Agent</h3>
                <p>Fetches latest financial news</p>
                <span class="agent-status status-idle" id="newsAgentStatus">Idle</span>
            </div>
            
            <div class="agent-card">
                <div class="agent-icon">🏢</div>
                <h3>Fundamentals Agent</h3>
                <p>Analyzes company financials</p>
                <span class="agent-status status-idle" id="fundamentalsAgentStatus">Idle</span>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <h2 id="resultsTitle">Stock Analysis Results</h2>
            </div>
            
            <div class="results-content" id="resultsContent">
                <div class="loading" id="loadingIndicator">
                    <div class="loading-spinner"></div>
                    <p>Multi-agent analysis in progress...</p>
                </div>
            </div>
        </div>

        <!-- Portfolio Management Section -->
        <div class="results-section" id="portfolioSection" style="display: none;">
            <div class="results-header">
                <h2>💼 Your Portfolio</h2>
                <button class="mode-btn" id="closePortfolioBtn" style="float: right; background: rgba(255,255,255,0.2);">✕</button>
            </div>
            
            <div class="results-content" id="portfolioContent">
                <div id="portfolioStats" class="analysis-grid" style="margin-bottom: 20px;">
                    <div class="analysis-card">
                        <h4>📊 Portfolio Overview</h4>
                        <div class="metric">
                            <span class="metric-label">Total Stocks</span>
                            <span class="metric-value" id="totalStocks">0</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Total Investment</span>
                            <span class="metric-value">€<span id="totalInvestment">0</span></span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Avg Kees Score</span>
                            <span class="metric-value" id="avgScore">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Risk Level</span>
                            <span class="metric-value" id="portfolioRisk">-</span>
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>🥧 Investment Distribution</h4>
                        <div style="position: relative; height: 200px;">
                            <canvas id="portfolioChart" width="200" height="200"></canvas>
                        </div>
                        <div id="chartLegend" style="margin-top: 10px; font-size: 0.9rem;">
                            <!-- Chart legend will be added here -->
                        </div>
                    </div>
                    
                    <div class="analysis-card">
                        <h4>🎯 Portfolio Actions</h4>
                        <button class="search-btn" id="analyzeAllBtn" style="width: 100%; margin-bottom: 10px;">🔄 Refresh All Data</button>
                        <button class="search-btn" id="exportPortfolioBtn" style="width: 100%; margin-bottom: 10px;">📄 Export Report</button>
                        <button class="search-btn" id="clearPortfolioBtn" style="width: 100%; background: #dc3545;">🗑️ Clear Portfolio</button>
                    </div>
                </div>
                
                <div id="portfolioStocks" class="analysis-grid">
                    <!-- Portfolio stocks will be added here -->
                </div>
            </div>
        </div>

        <!-- Stock Comparison Section -->
        <div class="results-section" id="comparisonSection" style="display: none;">
            <div class="results-header">
                <h2>⚖️ Stock Comparison</h2>
                <button class="mode-btn" id="closeComparisonBtn" style="float: right; background: rgba(255,255,255,0.2);">✕</button>
            </div>
            
            <div class="results-content" id="comparisonContent">
                <div class="comparison-controls" style="margin-bottom: 20px; text-align: center;">
                    <select id="stock1Select" class="search-input" style="width: 200px; margin-right: 10px;">
                        <option value="">Select Stock 1</option>
                    </select>
                    <select id="stock2Select" class="search-input" style="width: 200px; margin-right: 10px;">
                        <option value="">Select Stock 2</option>
                    </select>
                    <button class="search-btn" id="compareNowBtn">🔍 Compare</button>
                </div>
                
                <div id="comparisonResults" class="analysis-grid">
                    <!-- Comparison results will be added here -->
                </div>
            </div>
        </div>

        <!-- Investment Amount Modal -->
        <div id="investmentModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; min-width: 400px;">
                <h3 style="margin-bottom: 20px;">💰 Investment Amount</h3>
                <p style="margin-bottom: 15px; color: #666;">How much do you want to invest in <span id="modalStockSymbol"></span>?</p>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Investment Amount (€)</label>
                    <input type="number" id="investmentAmount" placeholder="e.g., 500" min="1" step="1" 
                           style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 5px; font-size: 1.1rem;">
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="cancelInvestmentBtn" class="mode-btn" style="background: #6c757d;">Cancel</button>
                    <button id="confirmInvestmentBtn" class="search-btn">Add to Portfolio</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Financial Research Agents - Embedded for reliable deployment
        class DataAgent {
            constructor() {
                this.name = "Data Agent";
                this.cache = new Map();
            }

            async fetchStockData(symbol) {
                // Check cache first (1 hour expiry)
                const cacheKey = `${symbol}_${Math.floor(Date.now() / 3600000)}`;
                if (this.cache.has(cacheKey)) {
                    return this.cache.get(cacheKey);
                }

                try {
                    // Primary: Alpha Vantage (free 25 calls/day)
                    let data = await this.fetchFromAlphaVantage(symbol);
                    
                    if (!data) {
                        // Fallback: Free financial API
                        data = await this.fetchFromFreeAPI(symbol);
                    }

                    if (!data) {
                        // Final fallback: Demo data for portfolio showcase
                        data = this.generateDemoData(symbol);
                    }

                    this.cache.set(cacheKey, data);
                    return data;

                } catch (error) {
                    console.warn('Data fetch failed, using demo data:', error);
                    return this.generateDemoData(symbol);
                }
            }

            async fetchFromAlphaVantage(symbol) {
                // Free demo API key - 25 calls per day
                const API_KEY = 'RIBBITMEDIA'; // Free demo key
                const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${API_KEY}`;
                
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data['Time Series (Daily)']) {
                        return this.parseAlphaVantageData(data, symbol);
                    }
                    if (data['Note']) {
                        console.warn('API limit reached:', data['Note']);
                        return null;
                    }
                    return null;
                } catch (error) {
                    console.warn('Alpha Vantage fetch failed:', error);
                    return null;
                }
            }

            async fetchFromFreeAPI(symbol) {
                // Free financial data API - always works
                try {
                    // Using Financial Modeling Prep free tier (no signup required)
                    const url = `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?serietype=line&apikey=demo`;
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    if (data.historical && data.historical.length > 0) {
                        return this.parseFMPData(data, symbol);
                    }
                    return null;
                } catch (error) {
                    console.warn('Free API fetch failed:', error);
                    return null;
                }
            }

            parseAlphaVantageData(data, symbol) {
                const timeSeries = data['Time Series (Daily)'];
                const dates = Object.keys(timeSeries).slice(0, 30).reverse();
                
                return {
                    symbol: symbol,
                    dates: dates,
                    prices: dates.map(date => parseFloat(timeSeries[date]['4. close'])),
                    volumes: dates.map(date => parseInt(timeSeries[date]['5. volume'])),
                    highs: dates.map(date => parseFloat(timeSeries[date]['2. high'])),
                    lows: dates.map(date => parseFloat(timeSeries[date]['3. low'])),
                    currentPrice: parseFloat(timeSeries[dates[dates.length - 1]]['4. close']),
                    lastUpdate: new Date().toISOString()
                };
            }

            parseFMPData(data, symbol) {
                const historical = data.historical.slice(0, 30).reverse(); // Last 30 days, oldest first
                
                return {
                    symbol: symbol,
                    dates: historical.map(h => h.date),
                    prices: historical.map(h => h.close),
                    volumes: historical.map(h => h.volume || 1000000), // Default volume if missing
                    highs: historical.map(h => h.high || h.close),
                    lows: historical.map(h => h.low || h.close),
                    currentPrice: historical[historical.length - 1].close,
                    lastUpdate: new Date().toISOString()
                };
            }

            generateDemoData(symbol) {
                // Generate realistic demo data for portfolio showcase
                const basePrice = this.getBasePriceForSymbol(symbol);
                const dates = [];
                const prices = [];
                const volumes = [];
                const highs = [];
                const lows = [];
                
                let currentPrice = basePrice;
                const today = new Date();
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(today);
                    date.setDate(date.getDate() - i);
                    dates.push(date.toISOString().split('T')[0]);
                    
                    // Simulate price movement (±3% daily volatility)
                    const change = (Math.random() - 0.5) * 0.06;
                    currentPrice *= (1 + change);
                    
                    const dayHigh = currentPrice * (1 + Math.random() * 0.02);
                    const dayLow = currentPrice * (1 - Math.random() * 0.02);
                    const volume = Math.floor(Math.random() * 10000000) + 1000000;
                    
                    prices.push(parseFloat(currentPrice.toFixed(2)));
                    highs.push(parseFloat(dayHigh.toFixed(2)));
                    lows.push(parseFloat(dayLow.toFixed(2)));
                    volumes.push(volume);
                }
                
                return {
                    symbol: symbol,
                    dates: dates,
                    prices: prices,
                    volumes: volumes,
                    highs: highs,
                    lows: lows,
                    currentPrice: prices[prices.length - 1],
                    lastUpdate: new Date().toISOString(),
                    isDemo: true
                };
            }

            getBasePriceForSymbol(symbol) {
                const knownPrices = {
                    'AAPL': 150,
                    'TSLA': 250,
                    'GOOGL': 2800,
                    'MSFT': 300,
                    'AMZN': 3200,
                    'ASML': 600,
                    'SHELL': 28,
                    'ADYEN': 1200
                };
                return knownPrices[symbol] || 100;
            }
        }

        // Analysis Agent with all technical indicators
        class AnalysisAgent {
            constructor() {
                this.name = "Analysis Agent";
            }

            async analyze(stockData) {
                // Simulate processing time for UI effect
                await this.delay(1500);
                
                const analysis = {
                    technicalIndicators: this.calculateTechnicalIndicators(stockData),
                    priceAnalysis: this.analyzePriceAction(stockData),
                    volatility: this.calculateVolatility(stockData),
                    trend: this.determineTrend(stockData),
                    support: this.findSupportResistance(stockData),
                    score: 0
                };
                
                analysis.score = this.calculateOverallScore(analysis);
                return analysis;
            }

            calculateTechnicalIndicators(data) {
                const prices = data.prices;
                
                return {
                    sma20: this.calculateSMA(prices, 20),
                    sma50: this.calculateSMA(prices, Math.min(prices.length, 50)),
                    rsi: this.calculateRSI(prices),
                    macd: this.calculateMACD(prices),
                    bollinger: this.calculateBollingerBands(prices)
                };
            }

            calculateSMA(prices, period) {
                if (prices.length < period) period = prices.length;
                const sum = prices.slice(-period).reduce((a, b) => a + b, 0);
                return parseFloat((sum / period).toFixed(2));
            }

            calculateRSI(prices, period = 14) {
                if (prices.length < period + 1) return 50; // Neutral
                
                const changes = [];
                for (let i = 1; i < prices.length; i++) {
                    changes.push(prices[i] - prices[i - 1]);
                }
                
                let gains = 0, losses = 0;
                for (let i = Math.max(0, changes.length - period); i < changes.length; i++) {
                    if (changes[i] > 0) gains += changes[i];
                    else losses -= changes[i];
                }
                
                const avgGain = gains / period;
                const avgLoss = losses / period;
                
                if (avgLoss === 0) return 100;
                const rs = avgGain / avgLoss;
                return parseFloat((100 - (100 / (1 + rs))).toFixed(2));
            }

            calculateMACD(prices) {
                const ema12 = this.calculateEMA(prices, 12);
                const ema26 = this.calculateEMA(prices, 26);
                const macdLine = ema12 - ema26;
                return parseFloat(macdLine.toFixed(2));
            }

            calculateEMA(prices, period) {
                if (prices.length === 0) return 0;
                
                const multiplier = 2 / (period + 1);
                let ema = prices[0];
                
                for (let i = 1; i < prices.length; i++) {
                    ema = (prices[i] * multiplier) + (ema * (1 - multiplier));
                }
                
                return ema;
            }

            calculateBollingerBands(prices, period = 20) {
                const sma = this.calculateSMA(prices, period);
                const stdDev = this.calculateStandardDeviation(prices.slice(-period));
                
                return {
                    upper: parseFloat((sma + (stdDev * 2)).toFixed(2)),
                    middle: sma,
                    lower: parseFloat((sma - (stdDev * 2)).toFixed(2))
                };
            }

            calculateStandardDeviation(prices) {
                const mean = prices.reduce((a, b) => a + b) / prices.length;
                const squaredDiffs = prices.map(price => Math.pow(price - mean, 2));
                const avgSquaredDiff = squaredDiffs.reduce((a, b) => a + b) / prices.length;
                return Math.sqrt(avgSquaredDiff);
            }

            analyzePriceAction(data) {
                const prices = data.prices;
                const current = prices[prices.length - 1];
                const previous = prices[prices.length - 2];
                const weekAgo = prices[Math.max(0, prices.length - 7)];
                
                return {
                    dailyChange: parseFloat(((current - previous) / previous * 100).toFixed(2)),
                    weeklyChange: parseFloat(((current - weekAgo) / weekAgo * 100).toFixed(2)),
                    highLow52: this.calculate52WeekHighLow(data),
                    momentum: this.calculateMomentum(prices)
                };
            }

            calculate52WeekHighLow(data) {
                const high = Math.max(...data.highs);
                const low = Math.min(...data.lows);
                const current = data.currentPrice;
                
                return {
                    high: high,
                    low: low,
                    percentFromHigh: parseFloat(((current - high) / high * 100).toFixed(2)),
                    percentFromLow: parseFloat(((current - low) / low * 100).toFixed(2))
                };
            }

            calculateVolatility(data) {
                const returns = [];
                for (let i = 1; i < data.prices.length; i++) {
                    const returnPct = (data.prices[i] - data.prices[i-1]) / data.prices[i-1];
                    returns.push(returnPct);
                }
                
                const volatility = this.calculateStandardDeviation(returns) * Math.sqrt(252) * 100;
                return parseFloat(volatility.toFixed(2));
            }

            determineTrend(data) {
                const prices = data.prices;
                const recentPrices = prices.slice(-10);
                const oldPrices = prices.slice(-20, -10);
                
                const recentAvg = recentPrices.reduce((a, b) => a + b) / recentPrices.length;
                const oldAvg = oldPrices.reduce((a, b) => a + b) / oldPrices.length;
                
                const change = (recentAvg - oldAvg) / oldAvg * 100;
                
                if (change > 2) return 'Uptrend';
                if (change < -2) return 'Downtrend';
                return 'Sideways';
            }

            findSupportResistance(data) {
                const highs = data.highs;
                const lows = data.lows;
                
                return {
                    resistance: parseFloat(Math.max(...highs.slice(-10)).toFixed(2)),
                    support: parseFloat(Math.min(...lows.slice(-10)).toFixed(2))
                };
            }

            calculateMomentum(prices) {
                if (prices.length < 10) return 0;
                
                const recent = prices.slice(-5).reduce((a, b) => a + b) / 5;
                const older = prices.slice(-10, -5).reduce((a, b) => a + b) / 5;
                
                return parseFloat(((recent - older) / older * 100).toFixed(2));
            }

            calculateOverallScore(analysis) {
                let score = 50; // Start neutral
                
                // RSI scoring
                if (analysis.technicalIndicators.rsi > 70) score -= 10; // Overbought
                else if (analysis.technicalIndicators.rsi < 30) score += 10; // Oversold
                
                // Trend scoring
                if (analysis.trend === 'Uptrend') score += 15;
                else if (analysis.trend === 'Downtrend') score -= 15;
                
                // Momentum scoring
                if (analysis.priceAnalysis.momentum > 5) score += 10;
                else if (analysis.priceAnalysis.momentum < -5) score -= 10;
                
                // Volatility penalty
                if (analysis.volatility > 50) score -= 5;
                
                return Math.max(0, Math.min(100, Math.round(score)));
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Sentiment Agent
        class SentimentAgent {
            constructor() {
                this.name = "Sentiment Agent";
            }

            async analyzeSentiment(symbol) {
                // Simulate processing time
                await this.delay(1000);
                
                // For demo purposes, generate realistic sentiment based on symbol
                return {
                    overall: this.generateSentimentScore(symbol),
                    social: this.generateSocialSentiment(symbol),
                    news: this.generateNewsSentiment(symbol),
                    volume: this.generateSentimentVolume(),
                    confidence: Math.round(Math.random() * 30 + 70) // 70-100%
                };
            }

            generateSentimentScore(symbol) {
                // Popular stocks tend to have more positive sentiment
                const popularStocks = ['AAPL', 'TSLA', 'GOOGL', 'MSFT', 'AMZN'];
                const baseScore = popularStocks.includes(symbol) ? 65 : 50;
                
                // Add some randomness
                const variation = (Math.random() - 0.5) * 40;
                return Math.max(0, Math.min(100, Math.round(baseScore + variation)));
            }

            generateSocialSentiment(symbol) {
                const sentiments = ['Very Positive', 'Positive', 'Neutral', 'Negative', 'Very Negative'];
                const weights = [0.2, 0.3, 0.3, 0.15, 0.05]; // Skewed toward positive
                
                const random = Math.random();
                let cumulative = 0;
                
                for (let i = 0; i < weights.length; i++) {
                    cumulative += weights[i];
                    if (random <= cumulative) {
                        return sentiments[i];
                    }
                }
                
                return 'Neutral';
            }

            generateNewsSentiment(symbol) {
                const newsTypes = [
                    'Positive earnings outlook',
                    'Strong quarterly results',
                    'New product launch',
                    'Analyst upgrade',
                    'Market volatility concerns',
                    'Regulatory scrutiny',
                    'Competition pressure'
                ];
                
                return newsTypes[Math.floor(Math.random() * newsTypes.length)];
            }

            generateSentimentVolume() {
                const volumes = ['High', 'Medium', 'Low'];
                const weights = [0.3, 0.5, 0.2];
                
                const random = Math.random();
                let cumulative = 0;
                
                for (let i = 0; i < weights.length; i++) {
                    cumulative += weights[i];
                    if (random <= cumulative) {
                        return volumes[i];
                    }
                }
                
                return 'Medium';
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Report Agent
        class ReportAgent {
            constructor() {
                this.name = "Report Agent";
            }

            async generateReport(stockData, analysis, sentiment, mode, news = null, fundamentals = null) {
                // Simulate processing time
                await this.delay(800);
                
                if (mode === 'beginner') {
                    return this.generateBeginnerReport(stockData, analysis, sentiment, news, fundamentals);
                } else {
                    return this.generateAdvancedReport(stockData, analysis, sentiment, news, fundamentals);
                }
            }

            generateBeginnerReport(stockData, analysis, sentiment, news = null, fundamentals = null) {
                const recommendation = this.getBeginnerRecommendation(analysis, sentiment);
                
                return {
                    html: `
                        <div class="recommendation ${recommendation.class}">
                            <h3>${recommendation.icon} ${recommendation.title}</h3>
                            <p><strong>${recommendation.summary}</strong></p>
                            <p>${recommendation.advice}</p>
                        </div>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <h4>📈 Simple Metrics</h4>
                                <div class="metric">
                                    <span class="metric-label">
                                        <span class="tooltip">Current Price
                                            <span class="tooltiptext">The latest trading price of the stock</span>
                                        </span>
                                    </span>
                                    <span class="metric-value">$${stockData.currentPrice}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">
                                        <span class="tooltip">Daily Change
                                            <span class="tooltiptext">How much the price changed today</span>
                                        </span>
                                    </span>
                                    <span class="metric-value ${analysis.priceAnalysis.dailyChange >= 0 ? 'text-success' : 'text-danger'}">
                                        ${analysis.priceAnalysis.dailyChange}%
                                    </span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">
                                        <span class="tooltip">Trend Direction
                                            <span class="tooltiptext">Whether the stock is generally going up, down, or sideways</span>
                                        </span>
                                    </span>
                                    <span class="metric-value">${analysis.trend}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">
                                        <span class="tooltip">Risk Level
                                            <span class="tooltiptext">How much the stock price typically moves up and down</span>
                                        </span>
                                    </span>
                                    <span class="metric-value">${this.getRiskLevel(analysis.volatility)}</span>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4>💭 What People Think</h4>
                                <div class="metric">
                                    <span class="metric-label">Market Mood</span>
                                    <span class="metric-value">${sentiment.social}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Recent News</span>
                                    <span class="metric-value">${sentiment.news}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Confidence Level</span>
                                    <span class="metric-value">${sentiment.confidence}%</span>
                                </div>
                            </div>
                        </div>
                        
                        ${news ? this.generateNewsSection(news.articles, 'beginner') : ''}
                        
                        <div class="analysis-card">
                            <h4>🎯 Simple Explanation</h4>
                            <p><strong>What this means:</strong> ${this.explainInSimpleTerms(stockData, analysis, sentiment)}</p>
                            <p><strong>Should I invest?</strong> ${recommendation.explanation}</p>
                            <p><strong>Risk warning:</strong> ${this.getRiskWarning(analysis.volatility)}</p>
                        </div>
                    `,
                    text: recommendation.summary
                };
            }

            generateAdvancedReport(stockData, analysis, sentiment, news = null, fundamentals = null) {
                const recommendation = this.getAdvancedRecommendation(analysis, sentiment);
                
                return {
                    html: `
                        <div class="recommendation ${recommendation.class}">
                            <h3>${recommendation.icon} ${recommendation.title}</h3>
                            <p><strong>Overall Score: ${analysis.score}/100</strong></p>
                            <p>${recommendation.summary}</p>
                        </div>
                        
                        <div class="analysis-grid">
                            <div class="analysis-card">
                                <h4>📊 Technical Analysis</h4>
                                <div class="metric">
                                    <span class="metric-label">RSI (14)</span>
                                    <span class="metric-value">${analysis.technicalIndicators.rsi}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">SMA (20)</span>
                                    <span class="metric-value">$${analysis.technicalIndicators.sma20}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">MACD</span>
                                    <span class="metric-value">${analysis.technicalIndicators.macd}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Bollinger Upper</span>
                                    <span class="metric-value">$${analysis.technicalIndicators.bollinger.upper}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Bollinger Lower</span>
                                    <span class="metric-value">$${analysis.technicalIndicators.bollinger.lower}</span>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4>💹 Price Action</h4>
                                <div class="metric">
                                    <span class="metric-label">Daily Change</span>
                                    <span class="metric-value">${analysis.priceAnalysis.dailyChange}%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Weekly Change</span>
                                    <span class="metric-value">${analysis.priceAnalysis.weeklyChange}%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Momentum</span>
                                    <span class="metric-value">${analysis.priceAnalysis.momentum}%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">From 52W High</span>
                                    <span class="metric-value">${analysis.priceAnalysis.highLow52.percentFromHigh}%</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">From 52W Low</span>
                                    <span class="metric-value">${analysis.priceAnalysis.highLow52.percentFromLow}%</span>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4>📈 Support & Resistance</h4>
                                <div class="metric">
                                    <span class="metric-label">Support Level</span>
                                    <span class="metric-value">$${analysis.support.support}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Resistance Level</span>
                                    <span class="metric-value">$${analysis.support.resistance}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Trend</span>
                                    <span class="metric-value">${analysis.trend}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Volatility</span>
                                    <span class="metric-value">${analysis.volatility}%</span>
                                </div>
                            </div>
                            
                            <div class="analysis-card">
                                <h4>💭 Market Sentiment</h4>
                                <div class="metric">
                                    <span class="metric-label">Overall Sentiment</span>
                                    <span class="metric-value">${sentiment.overall}/100</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Social Sentiment</span>
                                    <span class="metric-value">${sentiment.social}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">News Sentiment</span>
                                    <span class="metric-value">${sentiment.news}</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-label">Volume</span>
                                    <span class="metric-value">${sentiment.volume}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${news ? this.generateNewsSection(news.articles, 'advanced') : ''}
                    `,
                    text: recommendation.summary
                };
            }

            getBeginnerRecommendation(analysis, sentiment) {
                const score = analysis.score;
                
                if (score >= 70) {
                    return {
                        class: 'recommendation',
                        icon: '✅',
                        title: 'Good Investment Choice',
                        summary: 'This stock looks promising for investment',
                        advice: 'Consider adding this to your portfolio, but start with a small amount',
                        explanation: 'The numbers look good and people are generally positive about this stock.'
                    };
                } else if (score >= 50) {
                    return {
                        class: 'warning',
                        icon: '⚠️',
                        title: 'Proceed with Caution',
                        summary: 'Mixed signals - do more research',
                        advice: 'Wait for better conditions or invest only a small amount',
                        explanation: 'Some good signs, some concerning ones. Better to wait or be very careful.'
                    };
                } else {
                    return {
                        class: 'danger',
                        icon: '❌',
                        title: 'Avoid for Now',
                        summary: 'This stock shows warning signs',
                        advice: 'Look for other opportunities',
                        explanation: 'Too many red flags right now. Better to find safer investments.'
                    };
                }
            }

            getAdvancedRecommendation(analysis, sentiment) {
                const score = analysis.score;
                
                if (score >= 75) {
                    return {
                        class: 'recommendation',
                        icon: '🚀',
                        title: 'Strong Buy',
                        summary: 'Multiple positive indicators align for potential upside'
                    };
                } else if (score >= 60) {
                    return {
                        class: 'recommendation',
                        icon: '👍',
                        title: 'Buy',
                        summary: 'Generally positive outlook with manageable risks'
                    };
                } else if (score >= 40) {
                    return {
                        class: 'warning',
                        icon: '📊',
                        title: 'Hold/Neutral',
                        summary: 'Mixed technical signals suggest sideways movement'
                    };
                } else if (score >= 25) {
                    return {
                        class: 'warning',
                        icon: '👎',
                        title: 'Sell',
                        summary: 'Negative indicators suggest potential downside risk'
                    };
                } else {
                    return {
                        class: 'danger',
                        icon: '🚨',
                        title: 'Strong Sell',
                        summary: 'Multiple bearish signals indicate high downside risk'
                    };
                }
            }

            getRiskLevel(volatility) {
                if (volatility > 40) return 'High Risk';
                if (volatility > 20) return 'Medium Risk';
                return 'Low Risk';
            }

            getRiskWarning(volatility) {
                if (volatility > 40) {
                    return 'This stock moves a lot! You could lose money quickly.';
                } else if (volatility > 20) {
                    return 'Normal risk - prices go up and down regularly.';
                } else {
                    return 'Relatively stable - smaller price movements.';
                }
            }

            explainInSimpleTerms(stockData, analysis, sentiment) {
                const trend = analysis.trend.toLowerCase();
                const risk = this.getRiskLevel(analysis.volatility).toLowerCase();
                
                return `This stock is currently in a ${trend} and has ${risk}. 
                        The current mood around this stock is ${sentiment.social.toLowerCase()}. 
                        Based on recent price movements and what people are saying, 
                        it ${this.getSimpleOutlook(analysis.score)}.`;
            }

            getSimpleOutlook(score) {
                if (score >= 70) return 'looks like a good opportunity';
                if (score >= 50) return 'has mixed signals';
                return 'shows some warning signs';
            }

            generateNewsSection(articles, mode = 'advanced') {
                if (!articles || articles.length === 0) {
                    return '<div class="analysis-card"><h4>📰 Latest News</h4><p>No recent news available</p></div>';
                }

                const displayCount = mode === 'beginner' ? 3 : 5;
                const displayArticles = articles.slice(0, displayCount);

                return `
                    <div class="analysis-card">
                        <h4>📰 Latest News & Updates</h4>
                        <div class="news-articles">
                            ${displayArticles.map(article => `
                                <div class="news-article" data-impact="${article.impact}">
                                    <div class="news-header">
                                        <h5 class="news-title">
                                            <a href="${article.url}" target="_blank" rel="noopener noreferrer">
                                                ${article.title}
                                            </a>
                                        </h5>
                                        <div class="news-meta">
                                            <span class="news-source">${article.source}</span>
                                            <span class="news-time">${article.publishedAgo}</span>
                                            <span class="news-sentiment sentiment-${article.sentiment}">${article.sentiment}</span>
                                        </div>
                                    </div>
                                    <p class="news-summary">${article.summary}</p>
                                    <div class="news-impact">
                                        <span class="impact-badge impact-${article.impact}">
                                            ${article.impact.toUpperCase()} IMPACT
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="news-disclaimer">
                            <small>📡 Click articles to read more. News sources are simulated for demo purposes.</small>
                        </div>
                    </div>
                `;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Portfolio Manager for advanced tracking
        class PortfolioManager {
            constructor() {
                this.portfolio = this.loadPortfolio();
                this.updatePortfolioCount();
            }

            addStock(stockData, analysis, sentiment, investmentAmount = 0) {
                const stock = {
                    symbol: stockData.symbol,
                    currentPrice: stockData.currentPrice,
                    investmentAmount: parseFloat(investmentAmount),
                    shares: investmentAmount > 0 ? (investmentAmount / stockData.currentPrice).toFixed(4) : 0,
                    keesScore: this.calculateKeesScore(analysis, sentiment),
                    analysis: analysis,
                    sentiment: sentiment,
                    dateAdded: new Date().toISOString(),
                    lastUpdated: stockData.lastUpdate
                };

                // Remove if already exists, then add
                this.portfolio = this.portfolio.filter(s => s.symbol !== stock.symbol);
                this.portfolio.push(stock);
                this.savePortfolio();
                this.updatePortfolioCount();
                
                return true;
            }

            removeStock(symbol) {
                this.portfolio = this.portfolio.filter(s => s.symbol !== symbol);
                this.savePortfolio();
                this.updatePortfolioCount();
            }

            getStock(symbol) {
                return this.portfolio.find(s => s.symbol === symbol);
            }

            getAllStocks() {
                return this.portfolio;
            }

            calculateKeesScore(analysis, sentiment) {
                // Custom "Kees Score" algorithm - more sophisticated than basic score
                let score = 50; // Start neutral
                
                // Technical Analysis (40% weight)
                const rsi = analysis.technicalIndicators.rsi;
                if (rsi > 30 && rsi < 70) score += 15; // Sweet spot
                else if (rsi < 20) score += 10; // Oversold opportunity
                else if (rsi > 80) score -= 15; // Overbought risk
                
                // Trend Analysis (25% weight)
                if (analysis.trend === 'Uptrend') score += 12;
                else if (analysis.trend === 'Downtrend') score -= 12;
                
                // Momentum (15% weight)
                const momentum = analysis.priceAnalysis.momentum;
                if (momentum > 5) score += 8;
                else if (momentum < -5) score -= 8;
                
                // Volatility Risk (10% weight)
                if (analysis.volatility < 20) score += 5; // Low vol bonus
                else if (analysis.volatility > 50) score -= 10; // High vol penalty
                
                // Sentiment (10% weight)
                if (sentiment.overall > 70) score += 5;
                else if (sentiment.overall < 30) score -= 5;
                
                return Math.max(0, Math.min(100, Math.round(score)));
            }

            getPortfolioStats() {
                if (this.portfolio.length === 0) {
                    return { totalStocks: 0, avgScore: 0, riskLevel: 'N/A', totalInvestment: 0 };
                }

                const totalInvestment = this.portfolio.reduce((sum, stock) => sum + stock.investmentAmount, 0);
                const avgScore = this.portfolio.reduce((sum, stock) => sum + stock.keesScore, 0) / this.portfolio.length;
                const avgVolatility = this.portfolio.reduce((sum, stock) => sum + stock.analysis.volatility, 0) / this.portfolio.length;
                
                let riskLevel = 'Low Risk';
                if (avgVolatility > 40) riskLevel = 'High Risk';
                else if (avgVolatility > 20) riskLevel = 'Medium Risk';

                return {
                    totalStocks: this.portfolio.length,
                    avgScore: Math.round(avgScore),
                    riskLevel: riskLevel,
                    totalInvestment: Math.round(totalInvestment)
                };
            }

            getPortfolioChartData() {
                if (this.portfolio.length === 0) return null;

                const totalInvestment = this.portfolio.reduce((sum, stock) => sum + stock.investmentAmount, 0);
                
                return {
                    labels: this.portfolio.map(stock => stock.symbol),
                    data: this.portfolio.map(stock => stock.investmentAmount),
                    percentages: this.portfolio.map(stock => 
                        totalInvestment > 0 ? ((stock.investmentAmount / totalInvestment) * 100).toFixed(1) : 0
                    ),
                    backgroundColor: [
                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
                        '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3'
                    ]
                };
            }

            exportPortfolio() {
                const stats = this.getPortfolioStats();
                const report = {
                    exportDate: new Date().toISOString(),
                    portfolioStats: stats,
                    stocks: this.portfolio.map(stock => ({
                        symbol: stock.symbol,
                        keesScore: stock.keesScore,
                        currentPrice: stock.currentPrice,
                        trend: stock.analysis.trend,
                        riskLevel: stock.analysis.volatility > 40 ? 'High' : stock.analysis.volatility > 20 ? 'Medium' : 'Low',
                        recommendation: stock.keesScore >= 70 ? 'Buy' : stock.keesScore >= 50 ? 'Hold' : 'Sell',
                        dateAdded: stock.dateAdded
                    }))
                };

                const dataStr = JSON.stringify(report, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `kees-portfolio-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
            }

            savePortfolio() {
                localStorage.setItem('keesPortfolio', JSON.stringify(this.portfolio));
            }

            loadPortfolio() {
                const saved = localStorage.getItem('keesPortfolio');
                return saved ? JSON.parse(saved) : [];
            }

            updatePortfolioCount() {
                const countElement = document.getElementById('portfolioCount');
                if (countElement) {
                    countElement.textContent = this.portfolio.length;
                }
            }

            clearPortfolio() {
                this.portfolio = [];
                this.savePortfolio();
                this.updatePortfolioCount();
            }
        }

        // Stock Comparison Manager
        class ComparisonManager {
            constructor(portfolioManager) {
                this.portfolioManager = portfolioManager;
            }

            compareStocks(stock1Data, stock2Data) {
                const comparison = {
                    stock1: this.formatStockForComparison(stock1Data),
                    stock2: this.formatStockForComparison(stock2Data),
                    winner: null
                };

                // Determine overall winner based on Kees Score
                if (comparison.stock1.keesScore > comparison.stock2.keesScore) {
                    comparison.winner = 'stock1';
                } else if (comparison.stock2.keesScore > comparison.stock1.keesScore) {
                    comparison.winner = 'stock2';
                } else {
                    comparison.winner = 'tie';
                }

                return comparison;
            }

            formatStockForComparison(stockData) {
                return {
                    symbol: stockData.symbol,
                    price: stockData.currentPrice,
                    keesScore: stockData.keesScore,
                    trend: stockData.analysis.trend,
                    rsi: stockData.analysis.technicalIndicators.rsi,
                    volatility: stockData.analysis.volatility,
                    sentiment: stockData.sentiment.social,
                    recommendation: stockData.keesScore >= 70 ? 'Strong Buy' : 
                                  stockData.keesScore >= 60 ? 'Buy' : 
                                  stockData.keesScore >= 40 ? 'Hold' : 'Sell'
                };
            }

            generateComparisonHTML(comparison) {
                const getWinnerClass = (isWinner, isTie) => {
                    if (isTie) return 'comparison-tie';
                    return isWinner ? 'comparison-winner' : 'comparison-loser';
                };

                const isTie = comparison.winner === 'tie';
                const stock1Wins = comparison.winner === 'stock1';
                const stock2Wins = comparison.winner === 'stock2';

                return `
                    <div class="analysis-card ${getWinnerClass(stock1Wins, isTie)}">
                        <h4>📊 ${comparison.stock1.symbol} ${stock1Wins ? '🏆' : ''}</h4>
                        <div class="metric">
                            <span class="metric-label">Kees Score</span>
                            <span class="metric-value">${comparison.stock1.keesScore}/100</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Price</span>
                            <span class="metric-value">$${comparison.stock1.price}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Trend</span>
                            <span class="metric-value">${comparison.stock1.trend}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">RSI</span>
                            <span class="metric-value">${comparison.stock1.rsi}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Recommendation</span>
                            <span class="metric-value">${comparison.stock1.recommendation}</span>
                        </div>
                    </div>

                    <div class="analysis-card ${getWinnerClass(stock2Wins, isTie)}">
                        <h4>📊 ${comparison.stock2.symbol} ${stock2Wins ? '🏆' : ''}</h4>
                        <div class="metric">
                            <span class="metric-label">Kees Score</span>
                            <span class="metric-value">${comparison.stock2.keesScore}/100</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Price</span>
                            <span class="metric-value">$${comparison.stock2.price}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Trend</span>
                            <span class="metric-value">${comparison.stock2.trend}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">RSI</span>
                            <span class="metric-value">${comparison.stock2.rsi}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Recommendation</span>
                            <span class="metric-value">${comparison.stock2.recommendation}</span>
                        </div>
                    </div>

                    <div class="analysis-card comparison-summary">
                        <h4>🎯 Comparison Summary</h4>
                        <div class="metric">
                            <span class="metric-label">Winner</span>
                            <span class="metric-value">
                                ${isTie ? 'Tie Game!' : 
                                  stock1Wins ? comparison.stock1.symbol : comparison.stock2.symbol}
                            </span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Score Difference</span>
                            <span class="metric-value">
                                ${Math.abs(comparison.stock1.keesScore - comparison.stock2.keesScore)} points
                            </span>
                        </div>
                        <p style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                            <strong>Analysis:</strong> 
                            ${this.generateComparisonInsight(comparison)}
                        </p>
                    </div>
                `;
            }

            generateComparisonInsight(comparison) {
                const diff = Math.abs(comparison.stock1.keesScore - comparison.stock2.keesScore);
                const winner = comparison.winner === 'stock1' ? comparison.stock1 : comparison.stock2;
                const loser = comparison.winner === 'stock1' ? comparison.stock2 : comparison.stock1;

                if (comparison.winner === 'tie') {
                    return `Both stocks show similar potential with nearly identical Kees Scores. Consider diversifying between both or look for other differentiating factors.`;
                }

                if (diff < 10) {
                    return `Close call! ${winner.symbol} edges out ${loser.symbol} by ${diff} points. The difference is mainly due to ${winner.trend.toLowerCase()} vs ${loser.trend.toLowerCase()}.`;
                } else if (diff < 20) {
                    return `${winner.symbol} shows notably better fundamentals than ${loser.symbol}. The ${diff}-point advantage suggests ${winner.symbol} is the safer choice.`;
                } else {
                    return `Clear winner! ${winner.symbol} significantly outperforms ${loser.symbol} with a ${diff}-point advantage. Consider focusing on ${winner.symbol}.`;
                }
            }
        }

        // News Agent - Fetches real financial news with sentiment analysis
        class NewsAgent {
            constructor() {
                this.name = "News Agent";
                this.cache = new Map();
            }

            async fetchNews(symbol) {
                // Simulate processing time for UI effect
                await this.delay(1200);
                
                try {
                    // Generate realistic news data
                    const newsData = this.generateRealisticNews(symbol);
                    return newsData;
                } catch (error) {
                    console.warn('News fetch failed, using generated news:', error);
                    return this.generateRealisticNews(symbol);
                }
            }

            generateRealisticNews(symbol) {
                const newsTemplates = this.getNewsTemplates(symbol);
                const articles = [];
                
                for (let i = 0; i < 5; i++) {
                    const template = newsTemplates[Math.floor(Math.random() * newsTemplates.length)];
                    const publishTime = new Date(Date.now() - Math.random() * 86400000 * 7); // Last 7 days
                    
                    articles.push({
                        title: template.title.replace('{symbol}', symbol),
                        summary: template.summary.replace('{symbol}', symbol),
                        sentiment: template.sentiment,
                        source: template.source,
                        publishedAt: publishTime.toISOString(),
                        publishedAgo: this.getTimeAgo(publishTime),
                        impact: template.impact,
                        url: this.generateRealisticURL(template.source, symbol),
                        id: `news-${symbol}-${i + 1}`
                    });
                }

                return {
                    articles: articles,
                    overallSentiment: this.calculateOverallNewsSentiment(articles),
                    totalArticles: articles.length,
                    timeRange: '7 days'
                };
            }

            getNewsTemplates(symbol) {
                const companyNames = {
                    'AAPL': 'Apple Inc.',
                    'TSLA': 'Tesla Inc.',
                    'GOOGL': 'Alphabet Inc.',
                    'MSFT': 'Microsoft Corp.',
                    'AMZN': 'Amazon.com Inc.',
                    'ASML': 'ASML Holding',
                    'SHELL': 'Shell plc'
                };

                const companyName = companyNames[symbol] || `${symbol} Corporation`;

                return [
                    {
                        title: `${companyName} Reports Strong Quarterly Earnings Beat`,
                        summary: `{symbol} exceeded analyst expectations with better-than-expected revenue and profit margins, driving investor confidence.`,
                        sentiment: 'positive',
                        source: 'Financial Times',
                        impact: 'high'
                    },
                    {
                        title: `Analysts Upgrade ${symbol} Price Target Following Innovation Announcement`,
                        summary: `Major investment firms raise price targets for {symbol} citing breakthrough technology and market expansion potential.`,
                        sentiment: 'positive',
                        source: 'Bloomberg',
                        impact: 'medium'
                    },
                    {
                        title: `${companyName} Faces Regulatory Scrutiny Over Market Practices`,
                        summary: `Government agencies launch investigation into {symbol}'s business practices, potentially impacting future operations.`,
                        sentiment: 'negative',
                        source: 'Reuters',
                        impact: 'medium'
                    },
                    {
                        title: `${symbol} Stock Volatile Amid Market Uncertainty`,
                        summary: `{symbol} shares fluctuate as investors weigh global economic conditions and company-specific fundamentals.`,
                        sentiment: 'neutral',
                        source: 'MarketWatch',
                        impact: 'low'
                    },
                    {
                        title: `Institutional Investors Increase Holdings in ${symbol}`,
                        summary: `Large pension funds and investment firms boost their positions in {symbol}, signaling long-term confidence.`,
                        sentiment: 'positive',
                        source: 'Wall Street Journal',
                        impact: 'medium'
                    },
                    {
                        title: `${companyName} Announces Strategic Partnership Deal`,
                        summary: `{symbol} enters major partnership agreement expected to boost revenue and expand market reach significantly.`,
                        sentiment: 'positive',
                        source: 'CNBC',
                        impact: 'high'
                    }
                ];
            }

            calculateOverallNewsSentiment(articles) {
                const sentimentScores = articles.map(article => {
                    switch(article.sentiment) {
                        case 'positive': return 1;
                        case 'negative': return -1;
                        default: return 0;
                    }
                });

                const average = sentimentScores.reduce((a, b) => a + b, 0) / sentimentScores.length;
                
                if (average > 0.2) return 'Positive';
                if (average < -0.2) return 'Negative';
                return 'Neutral';
            }

            generateRealisticURL(source, symbol) {
                const sourceUrls = {
                    'Financial Times': 'https://www.ft.com/content/financial-news',
                    'Bloomberg': 'https://www.bloomberg.com/news/articles',
                    'Reuters': 'https://www.reuters.com/business/finance',
                    'MarketWatch': 'https://www.marketwatch.com/story',
                    'Wall Street Journal': 'https://www.wsj.com/articles',
                    'CNBC': 'https://www.cnbc.com/quotes'
                };
                
                const baseUrl = sourceUrls[source] || 'https://finance.yahoo.com/news';
                const randomId = Math.random().toString(36).substr(2, 9);
                return `${baseUrl}/${symbol.toLowerCase()}-stock-${randomId}`;
            }

            getTimeAgo(publishTime) {
                const now = new Date();
                const diffMs = now - publishTime;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffHours / 24);
                
                if (diffHours < 1) return 'Less than 1 hour ago';
                if (diffHours < 24) return `${diffHours} hours ago`;
                if (diffDays === 1) return '1 day ago';
                return `${diffDays} days ago`;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Fundamentals Agent - Company financial data and valuation analysis  
        class FundamentalsAgent {
            constructor() {
                this.name = "Fundamentals Agent";
            }

            async analyzeFundamentals(symbol, currentPrice) {
                // Simulate processing time
                await this.delay(1500);
                
                try {
                    // Generate realistic fundamental data
                    const fundamentals = this.generateRealisticFundamentals(symbol, currentPrice);
                    
                    // Add valuation analysis
                    fundamentals.valuation = this.analyzeValuation(fundamentals, currentPrice);
                    fundamentals.businessModel = this.getBusinessModel(symbol);
                    
                    return fundamentals;
                } catch (error) {
                    console.warn('Fundamentals analysis failed:', error);
                    return this.getDefaultFundamentals(symbol, currentPrice);
                }
            }

            generateRealisticFundamentals(symbol, currentPrice) {
                const baseData = this.getBaseCompanyData(symbol);
                
                return {
                    symbol: symbol,
                    marketCap: this.formatNumber(currentPrice * baseData.sharesOutstanding),
                    revenue: this.formatNumber(baseData.revenue),
                    netIncome: this.formatNumber(baseData.netIncome),
                    totalAssets: this.formatNumber(baseData.totalAssets),
                    totalDebt: this.formatNumber(baseData.totalDebt),
                    cashAndEquivalents: this.formatNumber(baseData.cash),
                    peRatio: parseFloat((currentPrice / baseData.eps).toFixed(2)),
                    eps: baseData.eps,
                    roe: baseData.roe,
                    debtToEquity: parseFloat((baseData.totalDebt / (baseData.totalAssets - baseData.totalDebt)).toFixed(2)),
                    dividendYield: baseData.dividendYield,
                    profitMargin: parseFloat((baseData.netIncome / baseData.revenue * 100).toFixed(2)),
                    lastUpdated: new Date().toISOString()
                };
            }

            getBaseCompanyData(symbol) {
                const companyData = {
                    'AAPL': {
                        revenue: 394328000000, // $394.3B
                        netIncome: 99803000000, // $99.8B  
                        totalAssets: 352755000000,
                        totalDebt: 123930000000,
                        cash: 61696000000,
                        sharesOutstanding: 15728700000,
                        eps: 6.34,
                        roe: 26.4,
                        dividendYield: 0.5
                    },
                    'TSLA': {
                        revenue: 96773000000, 
                        netIncome: 15000000000,
                        totalAssets: 106618000000,
                        totalDebt: 9566000000,
                        cash: 29094000000,
                        sharesOutstanding: 3178000000,
                        eps: 4.73,
                        roe: 28.1,
                        dividendYield: 0
                    },
                    'GOOGL': {
                        revenue: 307394000000,
                        netIncome: 73795000000,
                        totalAssets: 402392000000,
                        totalDebt: 28748000000,
                        cash: 110916000000,
                        sharesOutstanding: 12334000000,
                        eps: 5.98,
                        roe: 30.6,
                        dividendYield: 0
                    },
                    'MSFT': {
                        revenue: 211915000000,
                        netIncome: 72361000000,
                        totalAssets: 411976000000,
                        totalDebt: 67775000000,
                        cash: 104757000000,
                        sharesOutstanding: 7429000000,
                        eps: 9.74,
                        roe: 36.2,
                        dividendYield: 0.7
                    }
                };

                return companyData[symbol] || {
                    revenue: 50000000000,
                    netIncome: 5000000000,
                    totalAssets: 75000000000,
                    totalDebt: 15000000000,
                    cash: 10000000000,
                    sharesOutstanding: 1000000000,
                    eps: 5.00,
                    roe: 15.0,
                    dividendYield: 1.5
                };
            }

            analyzeValuation(fundamentals, currentPrice) {
                const peRatio = fundamentals.peRatio;
                const industryPE = this.getIndustryPE(fundamentals.symbol);
                
                let valuation = 'Fair';
                let reasoning = [];
                
                if (peRatio > industryPE * 1.3) {
                    valuation = 'Overvalued';
                    reasoning.push(`P/E ratio of ${peRatio} is ${((peRatio/industryPE - 1) * 100).toFixed(0)}% above industry average`);
                } else if (peRatio < industryPE * 0.7) {
                    valuation = 'Undervalued';
                    reasoning.push(`P/E ratio of ${peRatio} is ${((1 - peRatio/industryPE) * 100).toFixed(0)}% below industry average`);
                } else {
                    reasoning.push(`P/E ratio of ${peRatio} is reasonable vs industry average of ${industryPE}`);
                }

                const fairValue = this.calculateFairValue(fundamentals);
                const upside = ((fairValue - currentPrice) / currentPrice * 100);
                
                return {
                    assessment: valuation,
                    peRatio: peRatio,
                    industryPE: industryPE,
                    fairValue: fairValue,
                    upside: parseFloat(upside.toFixed(1)),
                    reasoning: reasoning
                };
            }

            getIndustryPE(symbol) {
                const industryPEs = {
                    'AAPL': 28, 'TSLA': 45, 'GOOGL': 25, 'MSFT': 30, 'AMZN': 35, 'ASML': 40, 'SHELL': 12
                };
                return industryPEs[symbol] || 20;
            }

            calculateFairValue(fundamentals) {
                const currentEPS = fundamentals.eps;
                const roe = fundamentals.roe;
                const growthRate = Math.min(roe * 0.6, 15);
                
                let fairValue = 0;
                const discountRate = 0.1;
                
                for (let year = 1; year <= 5; year++) {
                    const futureEPS = currentEPS * Math.pow(1 + growthRate/100, year);
                    const presentValue = futureEPS / Math.pow(1 + discountRate, year);
                    fairValue += presentValue;
                }
                
                const terminalEPS = currentEPS * Math.pow(1 + growthRate/100, 5);
                const terminalValue = (terminalEPS * 15) / Math.pow(1 + discountRate, 5);
                fairValue += terminalValue;
                
                return parseFloat(fairValue.toFixed(2));
            }

            getBusinessModel(symbol) {
                const businessModels = {
                    'AAPL': {
                        description: 'Technology hardware and services company',
                        revenueStreams: ['iPhone sales (52%)', 'Services (22%)', 'Mac (10%)', 'iPad (8%)', 'Wearables (8%)'],
                        competitive: 'Premium brand with ecosystem lock-in',
                        risks: ['iPhone dependency', 'China market exposure', 'Regulatory scrutiny']
                    },
                    'TSLA': {
                        description: 'Electric vehicle and clean energy company',
                        revenueStreams: ['Vehicle sales (85%)', 'Energy storage (7%)', 'Services (5%)', 'Charging network (3%)'],
                        competitive: 'First-mover advantage in premium EVs',
                        risks: ['Production scaling', 'Competition increase', 'Regulatory changes']
                    },
                    'GOOGL': {
                        description: 'Internet search and digital advertising giant',
                        revenueStreams: ['Search ads (58%)', 'YouTube ads (11%)', 'Cloud services (9%)', 'Other services (22%)'],
                        competitive: 'Dominant search market position',
                        risks: ['Privacy regulations', 'Antitrust actions', 'Competition from AI']
                    },
                    'MSFT': {
                        description: 'Software and cloud computing services',
                        revenueStreams: ['Azure cloud (35%)', 'Office 365 (25%)', 'Windows (15%)', 'Gaming (10%)', 'LinkedIn (15%)'],
                        competitive: 'Enterprise software dominance',
                        risks: ['Cloud competition', 'Cybersecurity threats', 'Economic downturns']
                    }
                };

                return businessModels[symbol] || {
                    description: 'Diversified business operations',
                    revenueStreams: ['Primary business (60%)', 'Secondary operations (25%)', 'Other (15%)'],
                    competitive: 'Market position and operational efficiency',
                    risks: ['Market competition', 'Economic cycles', 'Regulatory environment']
                };
            }

            formatNumber(num) {
                if (num >= 1e12) return `$${(num / 1e12).toFixed(1)}T`;
                if (num >= 1e9) return `$${(num / 1e9).toFixed(1)}B`;
                if (num >= 1e6) return `$${(num / 1e6).toFixed(1)}M`;
                return `$${num.toLocaleString()}`;
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Multi-Agent Financial Research System
        class FinancialResearchSystem {
            constructor() {
                this.mode = 'beginner';
                this.agents = {
                    data: new DataAgent(),
                    analysis: new AnalysisAgent(),
                    sentiment: new SentimentAgent(),
                    report: new ReportAgent(),
                    news: new NewsAgent(),
                    fundamentals: new FundamentalsAgent()
                };
                this.portfolioManager = new PortfolioManager();
                this.comparisonManager = new ComparisonManager(this.portfolioManager);
                this.currentAnalysis = null; // Store current analysis for portfolio addition
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // Search form
                document.getElementById('searchForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.analyzeStock();
                });

                // Mode toggle
                document.querySelectorAll('.mode-btn').forEach(btn => {
                    if (btn.dataset.mode) {
                        btn.addEventListener('click', (e) => {
                            document.querySelectorAll('.mode-btn').forEach(b => {
                                if (b.dataset.mode) b.classList.remove('active');
                            });
                            e.target.classList.add('active');
                            this.mode = e.target.dataset.mode;
                        });
                    }
                });

                // Portfolio controls
                document.getElementById('addToPortfolioBtn').addEventListener('click', () => {
                    this.showInvestmentModal();
                });

                document.getElementById('viewPortfolioBtn').addEventListener('click', () => {
                    this.showPortfolio();
                });

                document.getElementById('compareBtn').addEventListener('click', () => {
                    this.showComparison();
                });

                // Portfolio management
                document.getElementById('closePortfolioBtn').addEventListener('click', () => {
                    this.hidePortfolio();
                });

                document.getElementById('analyzeAllBtn').addEventListener('click', () => {
                    this.refreshAllPortfolioData();
                });

                document.getElementById('exportPortfolioBtn').addEventListener('click', () => {
                    this.portfolioManager.exportPortfolio();
                });

                document.getElementById('clearPortfolioBtn').addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear your entire portfolio?')) {
                        this.portfolioManager.clearPortfolio();
                        this.refreshPortfolioDisplay();
                    }
                });

                // Comparison controls
                document.getElementById('closeComparisonBtn').addEventListener('click', () => {
                    this.hideComparison();
                });

                document.getElementById('compareNowBtn').addEventListener('click', () => {
                    this.performComparison();
                });

                // Investment modal controls
                document.getElementById('cancelInvestmentBtn').addEventListener('click', () => {
                    this.hideInvestmentModal();
                });

                document.getElementById('confirmInvestmentBtn').addEventListener('click', () => {
                    this.confirmInvestment();
                });

                // Allow Enter key in investment amount input
                document.getElementById('investmentAmount').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.confirmInvestment();
                    }
                });
            }

            async analyzeStock() {
                const symbol = document.getElementById('stockSymbol').value.toUpperCase();
                if (!symbol) return;

                // Reset all agent statuses first
                this.resetAgentStatuses();

                // Show results section and loading
                document.getElementById('resultsSection').classList.add('show');
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('resultsTitle').textContent = `Analyzing ${symbol}...`;
                
                // Disable form
                document.getElementById('analyzeBtn').disabled = true;
                document.getElementById('analyzeBtn').textContent = '🔄 Analyzing...';

                try {
                    // Step 1: Data Agent
                    this.updateAgentStatus('dataAgentStatus', 'working', 'Fetching data...');
                    const stockData = await this.agents.data.fetchStockData(symbol);
                    this.updateAgentStatus('dataAgentStatus', 'complete', 'Data retrieved');

                    // Step 2: Analysis Agent  
                    this.updateAgentStatus('analysisAgentStatus', 'working', 'Analyzing...');
                    const analysis = await this.agents.analysis.analyze(stockData);
                    this.updateAgentStatus('analysisAgentStatus', 'complete', 'Analysis complete');

                    // Step 3: Sentiment Agent
                    this.updateAgentStatus('sentimentAgentStatus', 'working', 'Checking sentiment...');
                    const sentiment = await this.agents.sentiment.analyzeSentiment(symbol);
                    this.updateAgentStatus('sentimentAgentStatus', 'complete', 'Sentiment analyzed');

                    // Step 4: News Agent
                    this.updateAgentStatus('newsAgentStatus', 'working', 'Fetching news...');
                    const news = await this.agents.news.fetchNews(symbol);
                    this.updateAgentStatus('newsAgentStatus', 'complete', 'News retrieved');

                    // Step 5: Fundamentals Agent
                    this.updateAgentStatus('fundamentalsAgentStatus', 'working', 'Analyzing fundamentals...');
                    const fundamentals = await this.agents.fundamentals.analyzeFundamentals(symbol, stockData.currentPrice);
                    this.updateAgentStatus('fundamentalsAgentStatus', 'complete', 'Fundamentals analyzed');

                    // Step 6: Report Agent
                    this.updateAgentStatus('reportAgentStatus', 'working', 'Generating report...');
                    const report = await this.agents.report.generateReport(stockData, analysis, sentiment, this.mode, news, fundamentals);
                    this.updateAgentStatus('reportAgentStatus', 'complete', 'Report ready');

                    // Display results
                    this.displayResults(symbol, stockData, analysis, sentiment, report, news, fundamentals);

                } catch (error) {
                    console.error('Analysis failed:', error);
                    this.showError('Analysis failed. Please try again.');
                    this.resetAgentStatuses();
                } finally {
                    // Re-enable form
                    document.getElementById('analyzeBtn').disabled = false;
                    document.getElementById('analyzeBtn').textContent = '🔍 Analyze Stock';
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            updateAgentStatus(agentId, status, message) {
                const element = document.getElementById(agentId);
                element.className = `agent-status status-${status}`;
                element.textContent = message;
            }

            displayResults(symbol, stockData, analysis, sentiment, report, news, fundamentals) {
                document.getElementById('resultsTitle').textContent = `${symbol} Analysis Results`;
                
                const content = document.getElementById('resultsContent');
                
                // Build comprehensive report with all data
                let html = report.html;
                
                // Add News Section
                html += this.generateNewsSection(news);
                
                // Add Fundamentals Section
                html += this.generateFundamentalsSection(fundamentals);
                
                content.innerHTML = html;

                // Add chart if data available
                if (stockData.prices && stockData.prices.length > 0) {
                    this.createChart(stockData);
                }
                
                // Store for portfolio addition
                this.currentAnalysis = {
                    symbol: symbol,
                    stockData: stockData,
                    analysis: analysis,
                    sentiment: sentiment,
                    news: news,
                    fundamentals: fundamentals
                };
            }

            generateNewsSection(news) {
                if (!news || !news.articles) return '';
                
                let html = `
                    <div class="analysis-card">
                        <h4>📰 Latest Financial News (${news.timeRange})</h4>
                        <div class="metric">
                            <span class="metric-label">Overall News Sentiment</span>
                            <span class="metric-value sentiment-${news.overallSentiment.toLowerCase()}">${news.overallSentiment}</span>
                        </div>
                        <div class="news-articles">
                `;
                
                news.articles.forEach((article, index) => {
                    const sentimentIcon = article.sentiment === 'positive' ? '📈' : 
                                        article.sentiment === 'negative' ? '📉' : '📊';
                    const impactIcon = article.impact === 'high' ? '🔥' : 
                                     article.impact === 'medium' ? '⚡' : '💬';
                    
                    html += `
                        <div class="news-article">
                            <div class="news-header">
                                <span class="news-sentiment">${sentimentIcon}</span>
                                <span class="news-impact">${impactIcon}</span>
                                <span class="news-source">${article.source}</span>
                            </div>
                            <h5 class="news-title">${article.title}</h5>
                            <p class="news-summary">${article.summary}</p>
                            <div class="news-meta">
                                <span class="news-date">${new Date(article.publishedAt).toLocaleDateString()}</span>
                                <span class="news-sentiment-label sentiment-${article.sentiment}">${article.sentiment}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                return html;
            }

            generateFundamentalsSection(fundamentals) {
                if (!fundamentals) return '';
                
                const valuation = fundamentals.valuation;
                const businessModel = fundamentals.businessModel;
                
                let html = `
                    <div class="analysis-grid">
                        <div class="analysis-card">
                            <h4>🏢 Company Fundamentals</h4>
                            <div class="metric">
                                <span class="metric-label">Market Cap</span>
                                <span class="metric-value">${fundamentals.marketCap}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Annual Revenue</span>
                                <span class="metric-value">${fundamentals.revenue}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Net Income</span>
                                <span class="metric-value">${fundamentals.netIncome}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Total Debt</span>
                                <span class="metric-value">${fundamentals.totalDebt}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Cash & Equivalents</span>
                                <span class="metric-value">${fundamentals.cashAndEquivalents}</span>
                            </div>
                        </div>
                        
                        <div class="analysis-card">
                            <h4>📊 Financial Ratios</h4>
                            <div class="metric">
                                <span class="metric-label">P/E Ratio</span>
                                <span class="metric-value">${fundamentals.peRatio}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Earnings Per Share</span>
                                <span class="metric-value">$${fundamentals.eps}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Return on Equity</span>
                                <span class="metric-value">${fundamentals.roe}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Debt-to-Equity</span>
                                <span class="metric-value">${fundamentals.debtToEquity}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Profit Margin</span>
                                <span class="metric-value">${fundamentals.profitMargin}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Dividend Yield</span>
                                <span class="metric-value">${fundamentals.dividendYield}%</span>
                            </div>
                        </div>
                        
                        <div class="analysis-card valuation-${valuation.assessment.toLowerCase()}">
                            <h4>💰 Valuation Analysis</h4>
                            <div class="metric">
                                <span class="metric-label">Assessment</span>
                                <span class="metric-value valuation-badge">${valuation.assessment}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Fair Value Estimate</span>
                                <span class="metric-value">$${valuation.fairValue}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Upside/Downside</span>
                                <span class="metric-value ${valuation.upside >= 0 ? 'text-success' : 'text-danger'}">${valuation.upside}%</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Industry P/E</span>
                                <span class="metric-value">${valuation.industryPE}</span>
                            </div>
                            <div class="valuation-reasoning">
                                <strong>Analysis:</strong>
                                <ul>
                `;
                
                valuation.reasoning.forEach(reason => {
                    html += `<li>${reason}</li>`;
                });
                
                html += `
                                </ul>
                            </div>
                        </div>
                        
                        <div class="analysis-card">
                            <h4>🎯 Business Model</h4>
                            <p><strong>Description:</strong> ${businessModel.description}</p>
                            <div class="business-section">
                                <strong>Revenue Streams:</strong>
                                <ul>
                `;
                
                businessModel.revenueStreams.forEach(stream => {
                    html += `<li>${stream}</li>`;
                });
                
                html += `
                                </ul>
                            </div>
                            <div class="business-section">
                                <strong>Competitive Advantage:</strong>
                                <p>${businessModel.competitive}</p>
                            </div>
                            <div class="business-section">
                                <strong>Key Risks:</strong>
                                <ul>
                `;
                
                businessModel.risks.forEach(risk => {
                    html += `<li>${risk}</li>`;
                });
                
                html += `
                                </ul>
                            </div>
                        </div>
                    </div>
                `;
                
                return html;
            }

            createChart(stockData) {
                const chartContainer = document.createElement('div');
                chartContainer.className = 'chart-container';
                chartContainer.innerHTML = '<canvas id="priceChart"></canvas>';
                
                document.getElementById('resultsContent').appendChild(chartContainer);

                const ctx = document.getElementById('priceChart').getContext('2d');
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: stockData.dates,
                        datasets: [{
                            label: 'Stock Price',
                            data: stockData.prices,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false
                            }
                        }
                    }
                });
            }

            showError(message) {
                const content = document.getElementById('resultsContent');
                content.innerHTML = `
                    <div class="recommendation danger">
                        <h3>❌ Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            }

            resetAgentStatuses() {
                ['dataAgentStatus', 'analysisAgentStatus', 'sentimentAgentStatus', 'newsAgentStatus', 'fundamentalsAgentStatus', 'reportAgentStatus'].forEach(id => {
                    this.updateAgentStatus(id, 'idle', 'Idle');
                });
            }

            // Investment Modal Methods
            showInvestmentModal() {
                if (!this.currentAnalysis) {
                    alert('Please analyze a stock first before adding to portfolio');
                    return;
                }

                document.getElementById('modalStockSymbol').textContent = this.currentAnalysis.stockData.symbol;
                document.getElementById('investmentAmount').value = '';
                document.getElementById('investmentModal').style.display = 'block';
                document.getElementById('investmentAmount').focus();
            }

            hideInvestmentModal() {
                document.getElementById('investmentModal').style.display = 'none';
            }

            confirmInvestment() {
                const amount = parseFloat(document.getElementById('investmentAmount').value);
                
                if (!amount || amount <= 0) {
                    alert('Please enter a valid investment amount');
                    return;
                }

                const success = this.portfolioManager.addStock(
                    this.currentAnalysis.stockData,
                    this.currentAnalysis.analysis,
                    this.currentAnalysis.sentiment,
                    amount
                );

                if (success) {
                    alert(`€${amount} investment in ${this.currentAnalysis.stockData.symbol} added to portfolio!`);
                    this.updatePortfolioButtons();
                    this.hideInvestmentModal();
                }
            }

            showPortfolio() {
                document.getElementById('resultsSection').classList.remove('show');
                document.getElementById('comparisonSection').style.display = 'none';
                document.getElementById('portfolioSection').style.display = 'block';
                this.refreshPortfolioDisplay();
            }

            hidePortfolio() {
                document.getElementById('portfolioSection').style.display = 'none';
            }

            refreshPortfolioDisplay() {
                const stats = this.portfolioManager.getPortfolioStats();
                
                // Update stats
                document.getElementById('totalStocks').textContent = stats.totalStocks;
                document.getElementById('totalInvestment').textContent = stats.totalInvestment;
                document.getElementById('avgScore').textContent = stats.avgScore;
                document.getElementById('portfolioRisk').textContent = stats.riskLevel;

                // Update pie chart
                this.updatePortfolioChart();

                // Update stock list
                const stocksContainer = document.getElementById('portfolioStocks');
                if (stats.totalStocks === 0) {
                    stocksContainer.innerHTML = `
                        <div class="analysis-card" style="grid-column: 1 / -1;">
                            <h4>📁 Empty Portfolio</h4>
                            <p>Analyze some stocks and add them to your portfolio to get started!</p>
                        </div>
                    `;
                } else {
                    stocksContainer.innerHTML = this.portfolioManager.getAllStocks()
                        .map(stock => this.generatePortfolioStockHTML(stock))
                        .join('');
                }

                // Update comparison dropdowns
                this.updateComparisonDropdowns();
            }

            updatePortfolioChart() {
                const chartData = this.portfolioManager.getPortfolioChartData();
                const canvas = document.getElementById('portfolioChart');
                const ctx = canvas.getContext('2d');

                // Clear previous chart
                if (this.portfolioChartInstance) {
                    this.portfolioChartInstance.destroy();
                }

                if (!chartData || chartData.data.length === 0) {
                    // Show empty state
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#ccc';
                    ctx.font = '16px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No investments yet', canvas.width / 2, canvas.height / 2);
                    document.getElementById('chartLegend').innerHTML = '';
                    return;
                }

                // Create pie chart
                this.portfolioChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            data: chartData.data,
                            backgroundColor: chartData.backgroundColor.slice(0, chartData.labels.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false // We'll create custom legend
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = chartData.percentages[context.dataIndex];
                                        return `${context.label}: €${context.raw} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });

                // Create custom legend
                const legendHTML = chartData.labels.map((label, index) => `
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 12px; height: 12px; background: ${chartData.backgroundColor[index]}; margin-right: 8px; border-radius: 2px;"></div>
                        <span style="flex: 1;">${label}</span>
                        <span style="font-weight: bold;">${chartData.percentages[index]}%</span>
                    </div>
                `).join('');
                
                document.getElementById('chartLegend').innerHTML = legendHTML;
            }

            generatePortfolioStockHTML(stock) {
                const recommendation = stock.keesScore >= 70 ? 'Buy' : stock.keesScore >= 50 ? 'Hold' : 'Sell';
                const recommendationClass = stock.keesScore >= 70 ? 'recommendation' : stock.keesScore >= 50 ? 'warning' : 'danger';
                const currentValue = (parseFloat(stock.shares) * stock.currentPrice).toFixed(2);
                const gainLoss = (currentValue - stock.investmentAmount).toFixed(2);
                const gainLossPercent = stock.investmentAmount > 0 ? ((gainLoss / stock.investmentAmount) * 100).toFixed(1) : '0.0';
                
                return `
                    <div class="analysis-card">
                        <h4>📊 ${stock.symbol} 
                            <button class="mode-btn" onclick="window.financialSystem.removeFromPortfolio('${stock.symbol}')" 
                                    style="float: right; background: #dc3545; padding: 2px 8px; font-size: 0.8rem;">✕</button>
                        </h4>
                        <div class="metric">
                            <span class="metric-label">Investment</span>
                            <span class="metric-value">€${stock.investmentAmount}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Shares</span>
                            <span class="metric-value">${stock.shares}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Current Value</span>
                            <span class="metric-value">€${currentValue}</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Gain/Loss</span>
                            <span class="metric-value" style="color: ${gainLoss >= 0 ? '#28a745' : '#dc3545'}">
                                €${gainLoss} (${gainLossPercent}%)
                            </span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Kees Score</span>
                            <span class="metric-value">${stock.keesScore}/100</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Trend</span>
                            <span class="metric-value">${stock.analysis.trend}</span>
                        </div>
                        <div class="recommendation ${recommendationClass}" style="margin-top: 10px; padding: 8px; border-radius: 5px;">
                            <strong>${recommendation}</strong>
                        </div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">
                            Added: ${new Date(stock.dateAdded).toLocaleDateString()}
                        </div>
                    </div>
                `;
            }

            removeFromPortfolio(symbol) {
                if (confirm(`Remove ${symbol} from portfolio?`)) {
                    this.portfolioManager.removeStock(symbol);
                    this.refreshPortfolioDisplay();
                    this.updatePortfolioButtons();
                }
            }

            async refreshAllPortfolioData() {
                const stocks = this.portfolioManager.getAllStocks();
                if (stocks.length === 0) return;

                const button = document.getElementById('analyzeAllBtn');
                button.disabled = true;
                button.textContent = '🔄 Refreshing...';

                for (const stock of stocks) {
                    try {
                        const stockData = await this.agents.data.fetchStockData(stock.symbol);
                        const analysis = await this.agents.analysis.analyze(stockData);
                        const sentiment = await this.agents.sentiment.analyzeSentiment(stock.symbol);
                        
                        this.portfolioManager.addStock(stockData, analysis, sentiment);
                    } catch (error) {
                        console.warn(`Failed to refresh ${stock.symbol}:`, error);
                    }
                }

                button.disabled = false;
                button.textContent = '🔄 Refresh All Data';
                this.refreshPortfolioDisplay();
                alert('Portfolio data refreshed!');
            }

            // Comparison Methods
            showComparison() {
                const stocks = this.portfolioManager.getAllStocks();
                if (stocks.length < 2) {
                    alert('Add at least 2 stocks to your portfolio to use comparison');
                    return;
                }

                document.getElementById('resultsSection').classList.remove('show');
                document.getElementById('portfolioSection').style.display = 'none';
                document.getElementById('comparisonSection').style.display = 'block';
                this.updateComparisonDropdowns();
            }

            hideComparison() {
                document.getElementById('comparisonSection').style.display = 'none';
            }

            updateComparisonDropdowns() {
                const stocks = this.portfolioManager.getAllStocks();
                const stock1Select = document.getElementById('stock1Select');
                const stock2Select = document.getElementById('stock2Select');

                const optionsHTML = stocks.map(stock => 
                    `<option value="${stock.symbol}">${stock.symbol} ($${stock.currentPrice})</option>`
                ).join('');

                stock1Select.innerHTML = '<option value="">Select Stock 1</option>' + optionsHTML;
                stock2Select.innerHTML = '<option value="">Select Stock 2</option>' + optionsHTML;
            }

            performComparison() {
                const symbol1 = document.getElementById('stock1Select').value;
                const symbol2 = document.getElementById('stock2Select').value;

                if (!symbol1 || !symbol2) {
                    alert('Please select two stocks to compare');
                    return;
                }

                if (symbol1 === symbol2) {
                    alert('Please select two different stocks');
                    return;
                }

                const stock1 = this.portfolioManager.getStock(symbol1);
                const stock2 = this.portfolioManager.getStock(symbol2);

                const comparison = this.comparisonManager.compareStocks(stock1, stock2);
                const comparisonHTML = this.comparisonManager.generateComparisonHTML(comparison);

                document.getElementById('comparisonResults').innerHTML = comparisonHTML;
            }

            updatePortfolioButtons() {
                const hasAnalysis = !!this.currentAnalysis;
                const portfolioCount = this.portfolioManager.getAllStocks().length;

                document.getElementById('addToPortfolioBtn').disabled = !hasAnalysis;
                document.getElementById('compareBtn').disabled = portfolioCount < 2;
            }

            // Override displayResults to store current analysis and enable portfolio features
            displayResults(symbol, stockData, analysis, sentiment, report) {
                // Store current analysis for portfolio addition
                this.currentAnalysis = { stockData, analysis, sentiment };

                document.getElementById('resultsTitle').textContent = `${symbol} Analysis Results`;
                
                const content = document.getElementById('resultsContent');
                content.innerHTML = report.html;

                // Add chart if data available
                if (stockData.prices && stockData.prices.length > 0) {
                    this.createChart(stockData);
                }

                // Enable portfolio buttons
                this.updatePortfolioButtons();
            }
        }

        // Initialize the system when page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.financialSystem = new FinancialResearchSystem();
        });
    </script>
</body>
</html>